<ng-container *ngIf="(activeGoal$|async) as goal;">

  <app-page-title title="üèÜ GOAL:" [text]="goal.title"></app-page-title>

  <!-- BACK BUTTON -->
  <button [routerLink]="'/goals'" class="m-5 flex gap-3 items-center dark:hover:bg-gray-800 px-3 py-2 cursor-pointer border rounded">
    <mat-icon>arrow_back_ios_new</mat-icon>
    <span>My Goals</span>
  </button>
  <!-- BACK BUTTON -->

  <article class="bg-white dark:bg-gray-800 relative p-4 m-1 md:m-5 md:p-5 border rounded">

    <!-- Goal Details -->
    <section [@fadeGoalInOut] *ngIf="!editGoal">

      <!-- Edit Goal Icon -->
      <div class="absolute top-3 right-3">
        <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Goal menu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
          <button (click)="editGoal=true" mat-menu-item>
            <mat-icon>edit</mat-icon>
            <span>Edit</span>
          </button>
          <button (click)="deleteGoal(goal.id)" mat-menu-item>
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
          </button>
        </mat-menu>

      </div>
      <!-- Edit Goal Icon -->


      <!-- Goal Progress & Days Left -->
      <section class="my-8 flex flex-wrap md:flex-nowrap gap-3 justify-start md:justify-center items-center">

        <!--Progress bar -->
        <div class="w-[100%] border dark:border-gray-200 bg-gray-50 dark:bg-gray-600">
          <div class="text-center py-1 bg-green-600 dark:bg-green-800 text-gray-900 dark:text-gray-300"
               [style]="'width:'+(goal.progress).toFixed(2)+'%'">{{(goal.progress).toFixed(2)}}%
          </div>
        </div>
        <!--Progress bar -->

        <!-- TODO: calculate days left -->
        <div class="p-[0.30rem] whitespace-nowrap flex gap-1 items-center border">
          <mat-icon class="text-[24px]">schedule</mat-icon>
          <ng-container *ngIf="daysLeft == 'Overdue'; else daysLeftTemplate">
            <span class="text-rose-300">Overdue</span>
          </ng-container>
          <ng-template #daysLeftTemplate>
            <span>Days Left: <strong>{{daysLeft}}</strong></span>
          </ng-template>
        </div>

      </section>
      <!-- Goal Progress & Days Left -->


      <!-- HTML Description -->
      <div [innerHTML]="goal.description"></div>
      <!-- HTML Description -->

      <!-- Goal Description -->
<!--      <pre class="p-5 border bg-gray-50 dark:bg-gray-700">{{goal.description}}</pre>-->
      <!-- Goal Description -->

      <!-- Start and Due Dates -->
      <div class="py-5 flex flex-wrap justify-between">

        <p class="flex items-center">
          <mat-icon class="mb-[9px] text-xl">calendar_today</mat-icon>
          <span>Start Date: {{goal.start_date| date: 'MMM d, y'}}</span>
        </p>

        <p class="flex items-center">
          <mat-icon class="mb-[5px] text-[24px]">event</mat-icon>
          <span>Due Date: {{goal.due_date| date: 'MMM d, y'}}</span>
        </p>
      </div>
      <!-- Start and Due Dates -->

    </section>
    <!-- Goal Details -->


    <!-- textAngular Editor -->

    <!-- textAngular Editor -->

    <!-- TODO: Reactive Form With Rich Text Editor  -->
<!--    <form (ngSubmit)="richEditHandler()"  [formGroup]="richEditGoalForm">-->


<!--      <div class="NgxEditor__Wrapper">-->
<!--        <ngx-editor-menu [editor]="editor"-->
<!--                         [toolbar]="toolbar"></ngx-editor-menu>-->
<!--        <ngx-editor [editor]="editor"-->
<!--                    formControlName="editorContent">-->
<!--        </ngx-editor>-->
<!--      </div>-->

<!--      <button type="submit">Update</button>-->
<!--    </form>-->
    <!-- TODO: Reactive Form With Rich Text Editor -->


    <!-- Edit Goal Form -->
    <form *ngIf="editGoal" [@fadeInOut] (ngSubmit)="editGoalFormHandler(editGoalForm)"
          #editGoalForm="ngForm"
          class="bg-white dark:bg-gray-800 mt-8 space-y-6 shadow p-10 rounded-lg
            shadow-2xl dark:shadow dark:shadow-gray-500">

      <input type="hidden" [ngModel]="goal.id" name="id" ngModel>

      <!-- Goal Title & Due Date Container-->
      <section class="flex flex-wrap">

        <!-- Goal Title Input-->
        <div>
          <label class="text-color-light dark:text-color-dark">Goal Title:</label>
          <div class="flex align-center border border-slate-600 rounded">
            <input class="w-full py-2 px-3 dark:bg-gray-800 dark:focus:bg-gray-900 dark:active:bg-gray-700"
                   type="text"
                   name="title"
                   #title="ngModel"
                   placeholder="Title..."
                   minlength="10"
                   required
                   [ngModel]="goal.title"
            />
          </div>
          <!-- Title Error messages -->
          <!-- Title Error messages -->
          <ng-container *ngIf="title.touched">
            <span *ngIf="title.errors?.['required']"
                  class="text-sm text-red-600">
              Please enter Title!
            </span>
            <span *ngIf="title.errors?.['minlength']"
                  class="text-sm text-red-600">
              The goal title must be at least 10 characters long!
            </span>
          </ng-container>
        </div>
        <!-- Goal Title Input-->

        <!-- Goal Due Date -->
        <div class="w-[150px]">
          <label class="text-color-light dark:text-color-dark">Due Date:</label>

          <div class="flex align-center border border-slate-600 rounded">
            <input class="w-full py-2 px-3 dark:bg-gray-800 dark:focus:bg-gray-900 dark:active:bg-gray-700"
                   type="date"
                   name="due_date"
                   #due_date="ngModel"
                   [ngModel]="dateFn.dateToInputDate(goal.due_date)"/>
          </div>

        </div>
        <!-- Goal Due Date -->

      </section>
      <!-- Goal Title & Due Date Container-->

      <!-- Goal Description Input Container-->
      <div>
        <div class="flex align-center border border-slate-600 rounded">

            <textarea
              class="w-full min-h-[175px] py-2 px-3 dark:bg-gray-800 dark:focus:bg-gray-900 dark:active:bg-gray-700"
              name="description"
              #description="ngModel"
              placeholder="Goal Description..."
              required
              [ngModel]="goal.description"></textarea>
        </div>
        <!-- Error messages -->
        <ng-container *ngIf="title.touched">
            <span *ngIf="description.errors?.['required']"
                  class="text-sm text-red-600">
              Description can not be empty!
            </span>
        </ng-container>
      </div>
      <!-- Goal Description Input Container-->

      <!-- Save Button -->
      <div>

        <button type="submit" class="relative btn-primary dark:btn-primary-dark">
          Save Changes
        </button>

        <button class="py-2 px-3 ml-3 border shadow dark:shadow-gray-300 rounded dark:active:bg-gray-700"
                type="button"
                (click)="editGoal=false">
          Cancel
        </button>

      </div>
      <!-- Save Button -->

    </form>
    <!-- Edit Goal Form -->

  </article>
  <!-- Goal Details -->

  <!-- Targets -->
  <section class="m-5">

    <app-targets-list (onTargetEvents)="onTargetEvent($event,goal)" [goalId]="goal.id" [dailyTarget]="dailyTarget"></app-targets-list>

  </section>
  <!-- Targets -->

</ng-container>

<!--TODO: when wrong ID or not exist show this or page not found? -->
<!--<ng-template #noGoal>-->
<!--  <h2 class="my-5 text-center text-2xl">No Goal Found! ü§∑‚Äç‚ôÇÔ∏è</h2>-->
<!--</ng-template>-->
